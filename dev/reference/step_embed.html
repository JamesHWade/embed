<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="step_embed creates a specification of a recipe step that
will convert a nominal (i.e. factor) predictor into a set of
scores derived from a tensorflow model via a word-embedding model.
embed_control is a simple wrapper for setting default options."><title>Encoding Factors into Multiple Columns — step_embed • embed</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Source%20Sans%20Pro-0.4.1/font.css" rel="stylesheet"><link href="../deps/_Source%20Code%20Pro-0.4.1/font.css" rel="stylesheet"><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Encoding Factors into Multiple Columns — step_embed"><meta property="og:description" content="step_embed creates a specification of a recipe step that
will convert a nominal (i.e. factor) predictor into a set of
scores derived from a tensorflow model via a word-embedding model.
embed_control is a simple wrapper for setting default options."><meta property="og:image" content="https://embed.tidymodels.org/logo.png"><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">embed</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Applications/GLM.html">Using Generalized Linear Models</a>
    <a class="dropdown-item" href="../articles/Applications/Tensorflow.html">Entity Embeddings of Categorical Variables using TensorFlow</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tidymodels/embed/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Encoding Factors into Multiple Columns</h1>
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/embed/blob/HEAD/R/tf.R" class="external-link"><code>R/tf.R</code></a></small>
      <div class="d-none name"><code>step_embed.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>step_embed</code> creates a <em>specification</em> of a recipe step that
will convert a nominal (i.e. factor) predictor into a set of
scores derived from a tensorflow model via a word-embedding model.
<code>embed_control</code> is a simple wrapper for setting default options.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">step_embed</span><span class="op">(</span>
  <span class="va">recipe</span>,
  <span class="va">...</span>,
  role <span class="op">=</span> <span class="st">"predictor"</span>,
  trained <span class="op">=</span> <span class="cn">FALSE</span>,
  outcome <span class="op">=</span> <span class="cn">NULL</span>,
  predictors <span class="op">=</span> <span class="cn">NULL</span>,
  num_terms <span class="op">=</span> <span class="fl">2</span>,
  hidden_units <span class="op">=</span> <span class="fl">0</span>,
  options <span class="op">=</span> <span class="fu">embed_control</span><span class="op">(</span><span class="op">)</span>,
  mapping <span class="op">=</span> <span class="cn">NULL</span>,
  history <span class="op">=</span> <span class="cn">NULL</span>,
  skip <span class="op">=</span> <span class="cn">FALSE</span>,
  id <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/rand_id.html" class="external-link">rand_id</a></span><span class="op">(</span><span class="st">"embed"</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu">embed_control</span><span class="op">(</span>
  loss <span class="op">=</span> <span class="st">"mse"</span>,
  metrics <span class="op">=</span> <span class="cn">NULL</span>,
  optimizer <span class="op">=</span> <span class="st">"sgd"</span>,
  epochs <span class="op">=</span> <span class="fl">20</span>,
  validation_split <span class="op">=</span> <span class="fl">0</span>,
  batch_size <span class="op">=</span> <span class="fl">32</span>,
  verbose <span class="op">=</span> <span class="fl">0</span>,
  callbacks <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>recipe</dt>
<dd><p>A recipe object. The step will be added to the
sequence of operations for this recipe.</p></dd>
<dt>...</dt>
<dd><p>One or more selector functions to choose variables.
For <code>step_embed</code>, this indicates the variables to be encoded
into a numeric format. See <code><a href="https://recipes.tidymodels.org/reference/selections.html" class="external-link">recipes::selections()</a></code> for more
details. For the <code>tidy</code> method, these are not currently used.</p></dd>
<dt>role</dt>
<dd><p>For model terms created by this step, what analysis
role should they be assigned?. By default, the function assumes
that the embedding variables created will be used as predictors in a model.</p></dd>
<dt>trained</dt>
<dd><p>A logical to indicate if the quantities for
preprocessing have been estimated.</p></dd>
<dt>outcome</dt>
<dd><p>A call to <code>vars</code> to specify which variable is
used as the outcome in the neural network.</p></dd>
<dt>predictors</dt>
<dd><p>An optional call to <code>vars</code> to specify any
variables to be added as additional predictors in the neural
network. These variables should be numeric and perhaps centered
and scaled.</p></dd>
<dt>num_terms</dt>
<dd><p>An integer for the number of resulting variables.</p></dd>
<dt>hidden_units</dt>
<dd><p>An integer for the number of hidden units
in a dense ReLu layer between the embedding and output later.
Use a value of zero for no intermediate layer (see Details
below).</p></dd>
<dt>options</dt>
<dd><p>A list of options for the model fitting process.</p></dd>
<dt>mapping</dt>
<dd><p>A list of tibble results that define the
encoding. This is <code>NULL</code> until the step is trained by
<code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code>.</p></dd>
<dt>history</dt>
<dd><p>A tibble with the convergence statistics for
each term. This is <code>NULL</code> until the step is trained by
<code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code>.</p></dd>
<dt>skip</dt>
<dd><p>A logical. Should the step be skipped when the
recipe is baked by <code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">recipes::bake()</a></code>? While all
operations are baked when <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code> is run, some
operations may not be able to be conducted on new data (e.g.
processing the outcome variable(s)). Care should be taken when
using <code>skip = TRUE</code> as it may affect the computations for
subsequent operations.</p></dd>
<dt>id</dt>
<dd><p>A character string that is unique to this step to identify it.</p></dd>
<dt>optimizer, loss, metrics</dt>
<dd><p>Arguments to pass to <code><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">keras::compile()</a></code></p></dd>
<dt>epochs, validation_split, batch_size, verbose, callbacks</dt>
<dd><p>Arguments to pass to <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">keras::fit()</a></code></p></dd>
</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An updated version of <code>recipe</code> with the new step added
to the sequence of existing steps (if any). For the <code>tidy</code>method, a tibble with columns <code>terms</code> (the selectors or
variables for encoding), <code>level</code> (the factor levels), and
several columns containing <code>embed</code> in the name.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Factor levels are initially assigned at random to the
new variables and these variables are used in a neural network
to optimize both the allocation of levels to new columns as well
as estimating a model to predict the outcome. See Section 6.1.2
of Francois and Allaire (2018) for more details.</p>
<p>The new variables are mapped to the specific levels seen at the
time of model training and an extra instance of the variables
are used for new levels of the factor.</p>
<p>One model is created for each call to <code>step_embed</code>. All terms
given to the step are estimated and encoded in the same model
which would also contain predictors give in <code>predictors</code> (if
any).</p>
<p>When the outcome is numeric, a linear activation function is
used in the last layer while softmax is used for factor outcomes
(with any number of levels).</p>
<p>For example, the <code>keras</code> code for a numeric outcome, one
categorical predictor, and no hidden units used here would be</p><div class="sourceCode"><pre><code><span class="fu">keras_model_sequential</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_embedding</span><span class="op">(</span>
    input_dim <span class="op">=</span> <span class="va">num_factor_levels_x</span> <span class="op">+</span> <span class="fl">1</span>,
    output_dim <span class="op">=</span> <span class="va">num_terms</span>,
    input_length <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_flatten</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span>, activation <span class="op">=</span> <span class="st">'linear'</span><span class="op">)</span></code></pre></div>

<p>If a factor outcome is used and hidden units were requested, the code
would be</p><div class="sourceCode"><pre><code><span class="fu">keras_model_sequential</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_embedding</span><span class="op">(</span>
    input_dim <span class="op">=</span> <span class="va">num_factor_levels_x</span> <span class="op">+</span> <span class="fl">1</span>,
    output_dim <span class="op">=</span> <span class="va">num_terms</span>,
    input_length <span class="op">=</span> <span class="fl">1</span>
   <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_flatten</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="va">hidden_units</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">layer_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="va">num_factor_levels_y</span>, activation <span class="op">=</span> <span class="st">'softmax'</span><span class="op">)</span></code></pre></div>

<p>Other variables specified by <code>predictors</code> are added as an
additional dense layer after <code>layer_flatten</code> and before the
hidden layer.</p>
<p>Also note that it may be difficult to obtain reproducible
results using this step due to the nature of Tensorflow (see
link in References).</p>
<p>tensorflow models cannot be run in parallel within the same
session (via <code>foreach</code> or <code>futures</code>) or the <code>parallel</code> package.
If using a recipes with this step with <code>caret</code>, avoid parallel
processing.</p>
    </div>
    <div class="section level2">
    <h2 id="tidying">Tidying<a class="anchor" aria-label="anchor" href="#tidying"></a></h2>
    <p>When you <code><a href="tidy.recipe.html">tidy()</a></code> this step, a tibble with columns
<code>terms</code> (the selectors or variables selected), <code>levels</code> (levels in variable),
and a number of columns with embedding information are returned.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Francois C and Allaire JJ (2018)
<em>Deep Learning with R</em>, Manning</p>
<p>"How can I obtain reproducible results using Keras during
development?" <a href="https://tinyurl.com/keras-repro" class="external-link">https://tinyurl.com/keras-repro</a></p>
<p>"Concatenate Embeddings for Categorical Variables with Keras"
<a href="https://flovv.github.io/Embeddings_with_keras_part2/" class="external-link">https://flovv.github.io/Embeddings_with_keras_part2/</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeldata.tidymodels.org" class="external-link">modeldata</a></span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">grants</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span class="r-in"><span class="va">grants_other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">grants_other</span>, <span class="fl">500</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="is_tf_available.html">is_tf_available</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in">  <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">num_ci</span> <span class="op">+</span> <span class="va">sponsor_code</span>, data <span class="op">=</span> <span class="va">grants_other</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span class="r-in">    <span class="fu">step_embed</span><span class="op">(</span><span class="va">sponsor_code</span>,</span>
<span class="r-in">      outcome <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span>,</span>
<span class="r-in">      options <span class="op">=</span> <span class="fu">embed_control</span><span class="op">(</span>epochs <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span class="r-in">    <span class="op">)</span></span>
<span class="r-in"><span class="op">}</span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p><p>Developed by Emil Hvitfeldt, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

  </div></footer></body></html>

